{% extends 'marketplace/base.html' %}
{% load humanize %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Product List - UZASPEA{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/product_list.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}
{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let loading = false;
        let page = 2;
        const productContainer = document.getElementById('product-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        let noMoreProducts = false;

        function loadMoreProducts() {
            if (loading || noMoreProducts) return;
            loading = true;
            loadingIndicator.style.display = 'block';

            let url = new URL(window.location.href);
            url.searchParams.set('page', page);

            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        noMoreProducts = true;
                        document.getElementById('end-of-scroll-message').style.display = 'block';
                        throw new Error('No more products');
                    }
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                productContainer.insertAdjacentHTML('beforeend', data);
                page++;
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function(tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                enableImageZoom();
            })
            .catch(error => {
                if (noMoreProducts) {
                    document.getElementById('end-of-scroll-message').style.display = 'block';
                }
                console.error('Error:', error);
            })
            .finally(() => {
                loading = false;
                loadingIndicator.style.display = 'none';
            });
        }

        window.addEventListener('scroll', function() {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 50 && !loading && !noMoreProducts) {
                loadMoreProducts();
            }
        });

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        function enableImageZoom() {
            const productImages = document.querySelectorAll('.product-image');
            productImages.forEach(image => {
                image.addEventListener('mouseover', function() {
                    this.style.transform = 'scale(1.1)';
                    this.style.transition = 'transform 0.3s ease';
                });
                image.addEventListener('mouseout', function() {
                    this.style.transform = 'scale(1)';
                    this.style.transition = 'transform 0.3s ease';
                });
            });
        }
        enableImageZoom();

        // Sidebar dropdowns: use Bootstrap's collapse API for reliability
        document.querySelectorAll('.category-chevron-btn').forEach(function(btn) {
            var target = btn.getAttribute('data-bs-target');
            var chevron = btn.querySelector('.category-chevron');
            var collapseEl = document.querySelector(target);
            if (collapseEl && chevron) {
                // Set initial state
                if (collapseEl.classList.contains('show')) {
                    chevron.classList.add('rotate-180');
                    btn.setAttribute('aria-expanded', 'true');
                } else {
                    chevron.classList.remove('rotate-180');
                    btn.setAttribute('aria-expanded', 'false');
                }
                // Listen for Bootstrap collapse events
                collapseEl.addEventListener('show.bs.collapse', function() {
                    chevron.classList.add('rotate-180');
                    btn.setAttribute('aria-expanded', 'true');
                });
                collapseEl.addEventListener('hide.bs.collapse', function() {
                    chevron.classList.remove('rotate-180');
                    btn.setAttribute('aria-expanded', 'false');
                });
                // Click handler: use Bootstrap's API
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl, {toggle: false});
                    if (collapseEl.classList.contains('show')) {
                        bsCollapse.hide();
                    } else {
                        // Close all others
                        document.querySelectorAll('.category-chevron-btn').forEach(function(otherBtn) {
                            var otherTarget = otherBtn.getAttribute('data-bs-target');
                            var otherCollapse = document.querySelector(otherTarget);
                            if (otherCollapse && otherCollapse !== collapseEl) {
                                var otherBsCollapse = bootstrap.Collapse.getOrCreateInstance(otherCollapse, {toggle: false});
                                otherBsCollapse.hide();
                            }
                        });
                        bsCollapse.show();
                    }
                });
            }
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
     <!-- Toggle Buttons for Mobile (at the top) -->
    <div class="d-lg-none toggle-section">
        <button class="btn btn-toggle-sidebar mb-3 me-2" type="button" data-bs-toggle="collapse" data-bs-target="#rightCollapse">Sidebar</button>
        <button class="btn btn-toggle-sidebar mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">Filters</button>
    </div>

    <div class="row">
        <!-- Left Sidebar (Filter Sidebar) -->
        <div class="col-lg-2 col-md-3 mb-4 order-2 filter-sidebar d-lg-block">
            <aside id="filterCollapse" class="collapse d-lg-block">
                <nav class="category-nav mb-3">
                    <div class="category-title px-2 pt-2 pb-1 fw-bold text-uppercase small" style="letter-spacing:1.2px; font-size:1em; border-bottom:1px solid #e9ecef; background:transparent; color:#222;">Product Categories</div>
                    <ul class="category-list nav flex-column mb-2" style="overflow-x:hidden;">
                        <li class="nav-item category-item {% if not selected_category %}active{% endif %}" style="border-radius:4px;">
                            <a href="{% url 'product_list' %}" class="nav-link category-link d-flex align-items-center px-2 py-1 fw-semibold text-dark" style="background: none;">
                                <i class="bi bi-grid me-2"></i> <span>All</span>
                            </a>
                        </li>
                        {% for category in categories %}
                            <li class="nav-item category-item {% if selected_category == category %}active{% endif %}" style="border-radius:4px;">
                                <div class="d-flex align-items-center px-2 py-1">
                                    <div class="d-flex align-items-center w-100">
                                        <a href="{{ category.get_absolute_url }}" class="nav-link category-link flex-grow-1 fw-normal text-dark d-flex align-items-center" style="font-size:0.98em; white-space:normal; overflow:hidden; text-overflow:ellipsis;">
                                            <i class="bi bi-folder2-open me-2" style="color:#888;"></i>
                                            <span class="flex-shrink-1 category-name-text" style="min-width:0;">{{ category.name }}</span>
                                        </a>
                                        {% if category.children.all %}
                                            <button class="btn btn-link btn-sm p-0 ms-1 category-chevron-btn" type="button" data-bs-toggle="collapse" data-bs-target="#cat-{{ category.id }}-sub" aria-expanded="false" aria-controls="cat-{{ category.id }}-sub" tabindex="-1" style="color:#888; align-items:center;" onclick="event.preventDefault(); event.stopPropagation();">
                                                <span style="display:inline-flex; align-items:center;">
                                                    <i class="bi bi-chevron-down small category-chevron" id="chevron-{{ category.id }}"></i>
                                                </span>
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if category.children.all %}
                                    <div class="collapse{% for subcategory in category.children.all %}{% if selected_category == subcategory %} show{% endif %}{% endfor %}" id="cat-{{ category.id }}-sub" data-bs-parent=".category-list">
                                        <ul class="subcategory-list nav flex-column ps-3 mb-1">
                                            {% for subcategory in category.children.all %}
                                                <li class="nav-item subcategory-item" style="border-radius:3px;">
                                                    <span class="d-flex align-items-center w-100">
                                                        <i class="bi bi-chevron-right small me-1 subcategory-chevron" style="color:#bbb; min-width:18px;"></i>
                                                        <a href="{{ subcategory.get_absolute_url }}" class="nav-link subcategory-link flex-grow-1 text-dark" style="font-size:0.96em; min-width:0; white-space:normal; overflow:hidden; text-overflow:ellipsis;">
                                                            <span class="flex-shrink-1 category-name-text" style="min-width:0;">{{ subcategory.name }}</span>
                                                        </a>
                                                    </span>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            <style>
                                .rotate-180 { transform: rotate(180deg); transition: transform 0.2s; }
                                .category-chevron { font-size: 1.1em; transition: transform 0.2s; }
                                .category-name-text { display: inline-block; max-width: 140px; white-space: normal; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; }
                                .category-chevron-btn { min-width: 24px; min-height: 24px; }
                            </style>
                            </li>
                        {% endfor %}
                    </ul>
                </nav>
                <form method="get" action="{% url 'product_list' %}" class="filter-form px-2">
                    <div class="row g-1 mb-2 align-items-center">
                        <div class="col-5">
                            <input type="number" class="form-control form-control-sm w-100" id="min_price" name="min_price" value="{{ min_price }}" min="0" placeholder="Min" style="background:#f8f9fa;">
                        </div>
                        <div class="col-2 d-flex align-items-center justify-content-center px-0">
                            <span class="mx-1 text-muted">-</span>
                        </div>
                        <div class="col-5">
                            <input type="number" class="form-control form-control-sm w-100" id="max_price" name="max_price" value="{{ max_price }}" min="0" placeholder="Max" style="background:#f8f9fa;">
                        </div>
                    </div>
                    <div class="row g-1 mb-2 align-items-center">
                        <div class="col-6">
                            <select class="form-select form-select-sm w-100" name="condition" style="background:#f8f9fa;">
                                <option value="" {% if not condition %}selected{% endif %}>All</option>
                                <option value="New" {% if condition == 'New' %}selected{% endif %}>New</option>
                                <option value="Used" {% if condition == 'Used' %}selected{% endif %}>Used</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <select class="form-select form-select-sm w-100" name="sort_by" onchange="this.form.submit()" style="background:#f8f9fa;">
                                <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Newest</option>
                                <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>Price ↑</option>
                                <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>Price ↓</option>
                                <option value="rating" {% if sort_by == 'rating' %}selected{% endif %}>Rating</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <button type="submit" class="btn btn-primary btn-sm flex-grow-1" style="font-weight:500;">Apply</button>
                        <a href="{% url 'product_list' %}" class="btn btn-secondary btn-sm flex-grow-1" style="font-weight:500;">Clear</a>
                    </div>
                    <input type="hidden" name="category" value="{{ selected_category_slug }}">
                </form>
            </aside>
        </div>

        <!-- Main Section -->
        <div class="col-lg-8 col-md-6 order-md-2 order-3 main-content">
            <div class="row product-grid" id="product-container">
                <!-- Specific Element -->
                <!-- Rest of the products -->
                {% for product in products %}
                    <div class="col-lg-3 col-md-4 col-sm-6 col-12">
                        <a href="{{ product.get_absolute_url }}" class="product-link">
                            <div class="card product-card">
                                <div class="product-image-wrapper">
                                    {% if product.get_first_image %}
                                        <img loading="lazy" src="{{ product.get_first_image.url }}" class="card-img-top product-image" alt="{{ product.name }}">
                                    {% elif product.images.all %}
                                        <img loading="lazy" src="{{ product.images.all.0.image.url }}" class="card-img-top product-image" alt="{{ product.name }}">
                                    {% else %}
                                        <img loading="lazy" src="{% static 'images/no_image.png' %}" class="card-img-top product-image" alt="No Image Available">
                                    {% endif %}
                                </div>
                                <div class="card-body product-details">
                                    <h3 class="product-title">{{ product.name }}</h3>
                                    <p class="product-description">{{ product.description|truncatewords:15 }}</p>
                                    <div class="product-meta">
                                        <span class="product-price">TSh {{ product.price|floatformat:0|intcomma }}</span>
                                        <span class="product-condition badge {% if product.condition == 'New' %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ product.get_condition_display }}
                                        </span>
                                    </div>
                                    <div class="product-meta seller-category">
                                        <p class="product-seller">
                                            <i class="bi bi-person me-1"></i> 
                                            <span class="seller-link">{{ product.seller.username }}</span>
                                            {% if product.seller.profile.is_verified and product.seller.profile.tier == 'premium' %}
                                                <span class="verified-badge ms-1 d-inline-flex align-items-center" title="Premium Seller"><img src="{% static 'images/gold_checkmark.png' %}" alt="Premium Badge" style="height:1.25em;width:1.25em;object-fit:contain;vertical-align:middle;display:inline-block;"></span>
                                            {% elif product.seller.profile.is_verified %}
                                                <span class="verified-badge ms-1 d-inline-flex align-items-center" title="Verified Seller"><img src="{% static 'images/greeen_ckeckmark.png' %}" alt="Verified Badge" style="height:1.25em;width:1.25em;object-fit:contain;vertical-align:middle;display:inline-block;"></span>
                                            {% endif %}
                                        </p>
                                        <p class="product-category">
                                            <i class="bi bi-folder me-1"></i> 
                                            <span class="category-link">{{ product.category.name }}</span>
                                        </p>
                                    </div>
                                    <div class="product-rating justify-content-center">
                                        {% if product.average_rating > 0 %}
                                            {% for i in "x"|ljust:product.average_rating %}
                                                <i class="bi bi-star-fill text-warning"></i>
                                            {% endfor %}
                                            {% for i in "x"|ljust:5|slice:":-"|add:product.average_rating %}
                                                <i class="bi bi-star text-warning"></i>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted small">No reviews</span>
                                        {% endif %}
                                    </div>
                                    
                                </div>
                            </div>
                        </a>
                    </div>
                {% empty %}
                    <div class="col-12">
                        <p class="no-products-message">No products found matching your criteria.</p>
                    </div>
                {% endfor %}
            </div>

            <div id="loading-indicator" class="mt-4 text-center" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="loading-message">Loading more products...</p>
            </div>
            <div id="end-of-scroll-message" class="mt-4 text-center alert alert-info" style="display: none; position:sticky; bottom:0; z-index:10;">
                <i class="bi bi-check-circle me-2"></i>You've reached the end of the product list.
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="col-lg-2 col-md-3 order-md-3 order-1 right-sidebar d-lg-block">
            <div id="rightCollapse" class="collapse d-lg-block sidebar-content">
                {% if not user.is_authenticated %}
                    <div class="card mb-4">
                        <div class="card-header">Subscribe to Newsletter</div>
                        <div class="card-body">
                            <p class="small text-muted">Get the latest updates and offers.</p>
                            <form method="post" action="{% url 'product_list' %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    {{ subscription_form|crispy }}
                                </div>
                                <button type="submit" class="btn btn-outline-primary" name="subscribe_submit">Subscribe</button>
                            </form>
                        </div>
                    </div>
                {% endif %}
                <!-- Verification Card -->
                {% if user.is_authenticated and profile %}
                    {% if not profile.is_verified %}
                        <div class="card mb-4 border-info">
                            <div class="card-header bg-info text-dark d-flex align-items-center">
                                <i class="bi bi-patch-question me-2"></i>
                                <span class="fw-bold">Get Verified</span>
                                <span class="ms-2"><i class="bi bi-check-square-fill text-success"></i></span>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">Upgrade your account to unlock more features!</p>
                                <a href="{% url 'subscription_choose_tier' %}" class="btn btn-info w-100">Upgrade</a>
                            </div>
                        </div>
                    {% elif profile.tier == 'standard' %}
                        <div class="card mb-4 border-success">
                            <div class="card-header bg-success text-white d-flex align-items-center">
                                <i class="bi bi-patch-check-fill me-2"></i>
                                <span class="fw-bold">Verified Seller</span>
                            </div>
                            <div class="card-body">
                                <span class="verified-badge ms-1 d-inline-flex align-items-center" title="Verified Seller"><img src="{% static 'images/greeen_ckeckmark.png' %}" alt="Verified Badge" style="height:1.25em;width:1.25em;object-fit:contain;vertical-align:middle;display:inline-block;"></span>
                                <span class="ms-2">You are verified. Your listings have increased trust and visibility.</span>
                                <div class="mt-2">
                                    <a href="{% url 'subscription_choose_tier' %}" class="premium-highlight btn btn-sm" style="font-weight:600;">Premium</a>
                                </div>
                            </div>
                        </div>
                    {% elif profile.tier == 'premium' %}
                        <div class="card mb-4 border-warning">
                            <div class="card-header bg-warning text-dark d-flex align-items-center">
                                <i class="bi bi-patch-check-fill me-2" style="color:gold;"></i>
                                <span class="fw-bold">Premium Dealer</span>
                            </div>
                            <div class="card-body">
                                <span class="verified-badge ms-1 d-inline-flex align-items-center" title="Premium Seller"><img src="{% static 'images/gold_checkmark.png' %}" alt="Premium Badge" style="height:1.25em;width:1.25em;object-fit:contain;vertical-align:middle;display:inline-block;"></span>
                                <span class="ms-2">You are a Premium Dealer. Enjoy maximum marketplace benefits!</span>
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
                <!-- ...existing social card... -->
                <div class="card mb-4">
                    <div class="card-header">Follow Us</div>
                    <div class="card-body">
                        <p class="text-muted small">Connect with us:</p>
                        <div class="row row-cols-2 g-2">
                            <div class="col"><a href="https://www.facebook.com/yourfacebookpage" class="social-icon d-flex justify-content-center align-items-center" data-bs-toggle="tooltip" data-bs-title="Facebook" target="_blank" rel="noopener noreferrer"><i class="bi bi-facebook"></i></a></div>
                            <div class="col"><a href="https://twitter.com/yourtwitterhandle" class="social-icon d-flex justify-content-center align-items-center" data-bs-toggle="tooltip" data-bs-title="Twitter" target="_blank" rel="noopener noreferrer"><i class="bi bi-twitter-x"></i></a></div>
                            <div class="col"><a href="https://www.instagram.com/yourinstagramusername/" class="social-icon d-flex justify-content-center align-items-center" data-bs-toggle="tooltip" data-bs-title="Instagram" target="_blank" rel="noopener noreferrer"><i class="bi bi-instagram"></i></a></div>
                            <div class="col"><a href="https://www.youtube.com/youryoutubechannel" class="social-icon d-flex justify-content-center align-items-center" data-bs-toggle="tooltip" data-bs-title="YouTube" target="_blank" rel="noopener noreferrer"><i class="bi bi-youtube"></i></a></div>
                        </div>
                    </div>
                </div>
                {% if offers and offers|length > 0 %}
                <div class="card mb-4" style="font-size:0.92em;">
                    <div class="card-header" style="font-size:1em;">Special Offers</div>
                    <div class="card-body p-2">
                        <ul class="list-group list-group-flush">
                            {% for offer in offers %}
                                <li class="list-group-item p-2">
                                    {% if offer.image %}
                                        <img loading="lazy" src="{{offer.image.url}}" class="img-fluid mb-2" alt="{{offer.title}}" style="max-height:70px;object-fit:cover;">
                                    {% endif %}
                                    <h6 class="mb-1" style="font-size:1em;">{{ offer.title }}</h6>
                                    <p class="mb-1" style="font-size:0.95em;line-height:1.3;">{{ offer.description|truncatewords:20 }}</p>
                                    {% if offer.link %}
                                        <a href="{{ offer.link }}" class="btn btn-xs btn-outline-primary" style="font-size:0.85em;padding:2px 8px;">{{ offer.button_text }}</a>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
                {% if news_items and news_items|length > 0 %}
                <div class="card mb-4" style="font-size:0.92em;">
                    <div class="card-header" style="font-size:1em;">Latest News</div>
                    <div class="card-body p-2">
                        <ul class="list-group list-group-flush">
                            {% for item in news_items %}
                                <li class="list-group-item p-2">
                                    <h6 class="mb-1" style="font-size:1em;">{{ item.title }}</h6>
                                    <p class="small text-muted mb-1">{{item.pub_date|date:"F j, Y"}}</p>
                                    <p class="mb-1" style="font-size:0.95em;line-height:1.3;">{{ item.content|truncatewords:25 }}</p>
                                    {% if item.link %}
                                        <a href="{{item.link}}" class="btn btn-xs btn-outline-secondary" style="font-size:0.85em;padding:2px 8px;">Read More</a>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}