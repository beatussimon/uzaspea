{% extends 'marketplace/base.html' %}
{% load humanize %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{{ product.name }} - UZASPEA{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/product_detail.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        {# --- Main Product Area (Image and Details) --- #}
        <div class="col-lg-8">
            <div class="row">
                <div class="col-md-6">
                    {# --- Image Carousel --- #}
                    <div id="productCarousel" class="carousel slide product-image-container" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for image in images %}
                                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                    <img src="{{ image.image.url }}" class="d-block w-100 product-image" alt="{{ product.name }}">
                                </div>
                            {% empty %}
                                <div class="carousel-item active">
                                    <img src="{% static 'images/no_image.png' %}" class="d-block w-100 product-image" alt="No image available">
                                </div>
                            {% endfor %}
                        </div>
                        {% if images|length > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6 product-details">
                    <h1 class="product-title">{{ product.name }}</h1>
                    <p class="product-price">TSh {{ product.price|floatformat:0|intcomma }}</p>

                    <div class="product-info">
                        <span class="seller-info">
                            <i class="bi bi-person me-1"></i>
                            Seller: <a href="{% url 'user_profile' product.seller.username %}">{{ product.seller.username }}</a>
                            {% if product.seller.profile.is_verified %}
                                <span class="verified-badge"><i class="bi bi-check-circle-fill"></i></span>
                            {% endif %}
                        </span>
                        <span class="product-category">
                            <i class="bi bi-folder me-1"></i>
                            <a href="{{ product.category.get_absolute_url }}" class="category-link">{{ product.category.name }}</a>
                        </span>
                    </div>

                    <p class="product-description"><i class="bi bi-info-circle me-1"></i>{{ product.description }}</p>

                    <div class="product-stock-info">
                        <span><i class="bi bi-boxes me-1"></i>Stock: {{ product.stock }}</span>
                        <span><i class="bi bi-tags me-1"></i>{{ product.get_condition_display }}</span>
                    </div>

                    {% if product.average_rating > 0 %}
                        <p class="product-rating">
                            <i class="bi bi-star-fill me-1 text-warning"></i>
                            {% for i in "x"|ljust:product.average_rating|stringformat:"i" %}
                                <i class="bi bi-star-fill text-warning"></i>
                            {% endfor %}
                            {% for i in "x"|ljust:5|slice:":-"|add:product.average_rating %}
                                <i class="bi bi-star text-warning"></i>
                            {% endfor %}
                            ({{ product.reviews.count }} reviews)
                        </p>
                    {% else %}
                        <p class="product-rating"><i class="bi bi-star me-1"></i>No reviews yet</p>
                    {% endif %}

                    {% if product.seller == user %}
                        <div class="product-actions mt-3">
                            <a href="{% url 'product_update' slug=product.slug %}" class="btn btn-warning me-2">Edit Product</a>
                            <a href="{% url 'product_delete' slug=product.slug %}" class="btn btn-danger">Delete Product</a>
                        </div>
                    {% elif product.is_available and product.stock > 0 %}
                        {% if request.user.is_authenticated %}
                            <form action="{% url 'add_to_cart' slug=product.slug %}" method="post" class="d-inline mt-3" id="add-to-cart-form" data-slug="{{ product.slug }}">
                                {% csrf_token %}
                                <div class="input-group quantity-selector">
                                    <button type="button" class="btn btn-outline-secondary quantity-decrement">-</button>
                                    <input type="text" name="quantity" value="1" min="1" max="{{ product.stock }}" class="form-control quantity-input" readonly>
                                    <button type="button" class="btn btn-outline-secondary quantity-increment">+</button>
                                    <button type="submit" class="btn btn-primary ms-2">Add to Cart</button>
                                </div>
                            </form>
                        {% else %}
                            <p class="mt-3"><a href="{% url 'login' %}?next={{ request.path }}" class="text-primary">Login</a> to add to cart.</p>
                        {% endif %}
                    {% else %}
                        <p class="out-of-stock mt-3">Out of Stock</p>
                    {% endif %}
                </div>
            </div>
            <hr class="my-4">

            {# --- Reviews Section --- #}
            <h2 class="section-title">Reviews</h2>
            {% if request.user.is_authenticated %}
                {% if has_reviewed %}
                    <p class="text-muted">You have already reviewed this product.</p>
                {% else %}
                    <form method="post" class="mb-4 review-form">
                        {% csrf_token %}
                        {{ review_form|crispy }}
                        <button type="submit" class="btn btn-primary" name="review_submit">Submit Review</button>
                    </form>
                {% endif %}
            {% else %}
                <p class="text-muted">Please <a href="{% url 'login' %}?next={{ request.path }}" class="text-primary">log in</a> to leave a review.</p>
            {% endif %}
            {% for review in reviews %}
                <div class="card review-card mb-3">
                    <div class="card-header review-header">
                        <span class="review-author">{{ review.user.username }}</span>
                        <span class="review-rating">
                            {% for i in "x"|ljust:review.rating %}
                                <i class="bi bi-star-fill text-warning"></i>
                            {% endfor %}
                            {% for i in "x"|ljust:5|slice:":-"|add:review.rating %}
                                <i class="bi bi-star text-warning"></i>
                            {% endfor %}
                        </span>
                        <span class="review-date text-muted small">{{ review.created_at|date:"F d, Y" }}</span>
                    </div>
                    <div class="card-body review-body">
                        <p class="review-comment">{{ review.comment }}</p>
                        {% if user.is_authenticated %}
                            <details class="reply-form">
                                <summary>Reply</summary>
                                <form method="post" class="mt-2">
                                    {% csrf_token %}
                                    {{ reply_form|crispy }}
                                    <input type="hidden" name="parent_id" value="{{ review.id }}">
                                    <button class="btn btn-sm btn-primary" type="submit" name="reply_submit">Reply</button>
                                </form>
                            </details>
                        {% endif %}
                        {% for reply in review.replies.all %}
                            <div class="reply-container mt-2">
                                <div class="card reply-card">
                                    <div class="card-body">
                                        <p class="card-text">{{ reply.comment }}</p>
                                        <p class="card-text"><small class="text-muted">By {{ reply.user.username }} on {{ reply.created_at|date:"F d, Y" }}</small></p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% empty %}
                <p class="text-muted">No reviews yet.</p>
            {% endfor %}
        </div>

        {# --- Related Products (Right Sidebar) --- #}
        <div class="col-lg-4 related-products-section">
            {% if related_products %}
                <h4 class="section-title">Related Products</h4>
                <div class="row row-cols-1 g-3" id="related-products-container">
                    {% for related_product in related_products %}
                        <div class="col">
                            <div class="card related-product-card h-100">
                                <div class="card-body">
                                    <a href="{{ related_product.get_absolute_url }}">
                                        {% if related_product.get_first_image %}
                                            <img src="{{ related_product.get_first_image.url }}" class="related-product-image" alt="{{ related_product.name }}">
                                        {% elif related_product.images.all %}
                                            <img src="{{ related_product.images.all.0.image.url }}" class="related-product-image" alt="{{ related_product.name }}">
                                        {% else %}
                                            <img src="{% static 'images/no_image.png' %}" class="related-product-image" alt="No Image">
                                        {% endif %}
                                    </a>
                                    <h6 class="related-product-title">
                                        <a href="{{ related_product.get_absolute_url }}">{{ related_product.name|truncatechars:30 }}</a>
                                    </h6>
                                    <p class="related-product-price">TSh {{ related_product.price|floatformat:0|intcomma }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    <div id="sentinel"></div>
                </div>
            {% else %}
                <p class="text-muted">No related products found.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- AJAX Add to Cart ---
    const addToCartForm = document.getElementById('add-to-cart-form');
    if (addToCartForm) {
        addToCartForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const slug = this.dataset.slug;
            const url = `/marketplace/cart/add/${slug}/`;

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
            })
            .then(response => response.ok ? response.json() : response.json().then(errData => Promise.reject(errData)))
            .then(data => {
                if (data.status === 'success') {
                    const cartCountElement = document.querySelector('.bi-cart + .badge');
                    if (cartCountElement) cartCountElement.textContent = data.cart_items_count;

                    const successMessage = document.createElement('div');
                    successMessage.classList.add('alert', 'alert-success', 'alert-dismissible', 'fade', 'show');
                    successMessage.setAttribute('role', 'alert');
                    successMessage.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.container').prepend(successMessage);
                    setTimeout(() => successMessage.remove(), 3000);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const errorMessage = document.createElement('div');
                errorMessage.classList.add('alert', 'alert-danger', 'alert-dismissible', 'fade', 'show');
                errorMessage.textContent = error.message || 'Failed to add to cart.';
                document.querySelector('.container').prepend(errorMessage);
                setTimeout(() => errorMessage.remove(), 5000);
            });
        });
    }

    // --- Quantity Selector ---
    const quantityInputs = document.querySelectorAll('.quantity-input');
    quantityInputs.forEach(input => {
        const decrement = input.parentElement.querySelector('.quantity-decrement');
        const increment = input.parentElement.querySelector('.quantity-increment');
        
        decrement.addEventListener('click', () => {
            let value = parseInt(input.value);
            if (value > parseInt(input.min)) input.value = value - 1;
        });
        
        increment.addEventListener('click', () => {
            let value = parseInt(input.value);
            let max = parseInt(input.max);
            if (value < max) input.value = value + 1;
        });
    });

    // --- Infinite Scroll for Related Products ---
    let loading = false;
    let nextPage = 2;
    const relatedProductsContainer = document.getElementById('related-products-container');
    const sentinel = document.getElementById('sentinel');
    const productSlug = "{{ product.slug | escapejs }}";

    function loadMoreRelatedProducts() {
        if (loading) return;
        loading = true;

        const url = `/marketplace/product/${productSlug}/related/?page=${nextPage}`;
        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.ok ? response.text() : Promise.reject('Network error'))
        .then(data => {
            if (!data.trim()) {
                observer.unobserve(sentinel);
                return;
            }
            relatedProductsContainer.insertAdjacentHTML('beforeend', data);
            nextPage++;
            loading = false;
        })
        .catch(error => {
            console.error('Error:', error);
            loading = false;
        });
    }

    const observer = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting && !loading) loadMoreRelatedProducts();
    }, { rootMargin: '100px' });

    if (sentinel) observer.observe(sentinel);

    // --- Tooltips ---
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
});
</script>
{% endblock %}